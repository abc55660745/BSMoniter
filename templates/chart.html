{% extends "base.html" %}
{% block title %}地图监控{% endblock %}
{% block include %}
    <script src="/static/echarts.min.js"></script>
    <script src="/static/socket.io.min.js"></script>
{% endblock %}
{% block pageTitle %}地图监控{% endblock %}
{% block float_right %}
    <div style="padding-top: 3px">
        <div class="bootstrap-switch" style="height: 32px">
            <input name="anim" type="checkbox" data-size="small" checked>
        </div>
    </div>&nbsp;&nbsp;
    <div id="pause">
        <button onclick="pause1()" type="button" class="btn btn-primary" title="暂停"><i class="fas fa-pause"></i>
        </button>
    </div>
    <div id="play" style="display: none">
        <button onclick="play1()" type="button" class="btn btn-primary" title="继续"><i class="fas fa-play"></i></button>
    </div>
    <div id="stopA">
        &nbsp;&nbsp;<button onclick="stopAll()" type="button" class="btn btn-primary" title="断开所有设备"><i
            class="fas fa-stop"></i>
    </button>
    </div>
{% endblock %}
{% block main %}
    <div class="row">
        <div class="col-md-12" id="ccc">
            <div id="chart"></div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script type="text/javascript">
        var paused = false
        var animate = true
        var stoped = false

        console.log(document.getElementById('ccc').clientWidth)

        function connectLast() {
            $.get('/startLast', function (data) {
                showBox(data)
            })
        }

        function stopAll() {
            showBox('正在处理，请稍后...')
            $.get('/stopAll', function (data) {
                showBox(data)
            })
            stoped = true
            $('#pause').hide()
            $('#play').show()
            $('#stopA').hide()
            chart.setOption({dataZoom: [{show: true}]})
        }

        function pause1() {
            paused = true
            $('#pause').hide()
            $('#play').show()
            chart.setOption({dataZoom: [{show: true}]})
        }

        function play1() {
            if (stoped) {
                connectLast()
            }
            paused = false
            stoped = false
            $('#pause').show()
            $('#play').hide()
            $('#stopA').show()
            chart.setOption({dataZoom: [{show: false}]})
        }

        var whRate = 2
        var width = document.getElementById('ccc').clientWidth
        var tarH = (width / whRate).toString() + "px"
        document.getElementById('chart').style.height = tarH
        let chart = echarts.init(document.getElementById('chart'))

        var options = {
            grid: {
                left: 35,
                right: 15,
                top: 10,
                bottom: 20
            },
            xAxis: {
                type: 'value',
                show: false,
                scale: true
            },
            yAxis: {
                type: 'value',
                show: false,
                scale: true
            },
            visualMap: {
                type: 'piecewise',
                categories: [
                    'Background', 'Obstacle', 'Robot', 'Goal', 'Other1', 'Other2', 'Other3'
                ],
                inRange: {
                    color: {
                        'Background': '#2C3E50',
                        'Obstacle': '#E74C3C',
                        'Robot': '#3498DB',
                        'Goal': '#EB7F00',
                        'Other1': '#2980B9',
                        'Other2': '#ACF0F2',
                        'Other3': '#1695A3',
                        '': '#F6F792'
                    }
                }
            },
            series: [
                {
                    name: 'Background',
                    type: 'heatmap',
                    data: [],
                    emphasis: {
                        show: false
                    },
                    zlevel: 0
                },
                {
                    name: 'other',
                    type: 'heatmap',
                    data: [],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    selectedMode: 'single',
                    zlevel: 1
                },
                {
                    name: 'path1',
                    type: 'line',
                    data: []
                },
                {
                    name: 'path2',
                    type: 'line',
                    data: []
                }
            ]
        };

        chart.setOption(options)

        var data = []

        function updateData(d) {
            var option = {series: [{}, {}, {}, {}]}
            if (d.background.length !== 0) {
                var backg = []

            }
        }

        function clear2() {

        }

        window.onresize = function () {
            var height = document.documentElement.clientHeight
            tarH = (height - 210).toString() + "px"
            chart.resize({height: tarH})
        }

        $('#menu').click(function () {
            setTimeout(function () {
                width = document.getElementById('ccc').clientWidth
                tarH = (width / whRate).toString() + "px"
                chart.resize({height: tarH})
            }, 300)
        })

        const socket = io('/ws');
        socket.on('data', function (data) {
            if (!paused) {
                updateData(data)
            }
        })
        socket.on('error', function () {
            showBox('出现异常错误<br/>错误信息请至配置列表或服务器后端查看')
        })
        socket.on('disconnect', function () {
            showBox('与服务器的连接异常断开，请刷新网页重新连接')
        })
        socket.on('connect_error', function () {
            showBox('与服务器的连接异常断开，请刷新网页重新连接')
        })
    </script>
{% endblock %}